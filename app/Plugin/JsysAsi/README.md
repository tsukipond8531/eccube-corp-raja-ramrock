# EC-CUBE4管理画面セキュリティ向上プラグイン

## 概要
2要素認証・IPアドレスロック等の機能を追加することにより、管理画面のセキュリティ向上を目的としたプラグインです。

本プラグインは、EC-CUBE4系で利用できます。

## 追加される機能
- 2要素認証（Google Authenticator）
- ログイン成功通知（メール）
- ログイン失敗通知（メール）
- IPアドレスロック
- ログイン履歴一覧

ログイン履歴一覧以外の機能はプラグイン設定より有効/無効の切り替えが可能です。

## 機能説明
### 2要素認証（Google Authenticator）
管理ログイン画面に認証コードが追加されます。  
管理画面→2要素認証管理→ユーザー設定からメンバーを登録することで、ユーザーID・パスワード・認証コードでログインができるようになります。

未設定のメンバーは通常通り、ユーザーID・パスワードでのログインとなります。

また、緊急時には下記の手段があります。

##### マスターキー
機能有効時に発行されるキーを使用してログインします。  
使用後は2要素認証が無効になり、マスターキーがクリアされます。

##### 管理者パラメータ
指定されたパラメータを追加することで、2要素認証そのものを回避します。
_service.yaml_
```
parameters:
  jsys_asi_tfa_supervisor: true
```

### ログイン成功通知（メール）
管理画面へログインしたタイミングでメールを送信します。  
宛先は店舗設定の送信元メールアドレスになります。  
本文には、ショップ名・ログインID・メンバー名・ログイン日時・IPアドレス・UserAgentが記載されます。

### ログイン失敗通知（メール）
管理画面へのログインに失敗したタイミングでメールを送信します。  
宛先は店舗設定の送信元メールアドレスになります。  
本文には、ショップ名・試行ログインID・ログイン試行日時・IPアドレス・UserAgentが記載されます。

### IPアドレスロック
連続してログインに失敗したIPアドレスをロックし、ログインを拒否します。  
失敗可能な回数は、プラグイン設定から設定が可能です。

管理画面→ログイン管理→ロック済み一覧からロックされたIPアドレスの確認と、ロックの解除が出来ます。

また、緊急時には下記の手段があります。

##### 管理者パラメータ
指定されたパラメータを追加することで、ロックそのものを回避します。  
_service.yaml_
```
parameters:
  jsys_asi_lock_supervisor: true
```

### ログイン履歴一覧
管理画面→ログイン管理→ログイン履歴からログインの成否が確認出来ます。  

履歴には、日時・ログインID・IPアドレス・ログイン結果(結果)・2要素認証結果(2要素)・IPアドレスロック結果(ロック)・UserAgentが表示されます。

結果・2要素・ロックはアイコンで表示されます。
- 結果 &check;:成功, &times;:失敗, &#33;:拒否
- 2要素 -:無効, &check;:有効, &times;:無効, &#33;:使用済
- ロック -:無効, &check;:未ロック, &times;:ロック済

## services.yamlに設定できるパラメータ一覧
| キー | デフォルト | 説明 |
| --- | --- | --- |
| jsys_asi_tfa_supervisor | false | ２要素認証有効時でも検証しない、コードチェックで使用 |
| jsys_asi_tfa_issuer | ショップ名 | ２要素認証の発行者、認証アプリで使用 |
| jsys_asi_tfa_code_len | 6 | ２要素認証の認証コードの桁数、桁数チェックで使用 |
| jsys_asi_tfa_otp_banned_min | 5 | ２要素認証のOTPの使用無効時間（分）、使用済みチェックで使用 |
| jsys_asi_lock_supervisor | false | アカウントロック有効時でも検証しない、ロック有無チェックで使用 |
| jsys_asi_tfa_server | null | ２要素認証の発行サーバー、認証アプリで使用 |
| jsys_asi_tfa_digits | 6 | ２要素認証の発行する認証コードの桁数、コード発行で使用 |
| jsys_asi_tfa_window | 1 | ２要素認証の有効コード数、コードチェックで使用 |

## EC-CUBE4.1の2段階認証との共存について
エラーなどは出ないため、共存は可能ですが非推奨です。  
本プラグインはログイン処理に、デフォルトの2段階認証はログイン後に割り込みます。  
そのため、プラグインの処理が終わってからデフォルトの認証処理が実行されることになり、  
ログイン成功メールが来たが、デフォルトの認証でログインできないといった状態になる可能性があります。

ログイン履歴やメールでの不正アクセス判断が難しくなるため、非推奨とします。

## このプラグインの購入について
EC-CUBEオーナーズストアから購入することができます。  
https://www.ec-cube.net/products/detail.php?product_id=2268